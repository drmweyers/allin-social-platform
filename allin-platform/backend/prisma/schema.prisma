// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [vector]
}

// ========================================
// USER & AUTHENTICATION MODELS
// ========================================

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  emailVerified     DateTime?
  name              String?
  password          String?
  image             String?
  role              UserRole  @default(USER)
  status            UserStatus @default(PENDING)

  // Relations
  sessions          Session[]
  verificationTokens VerificationToken[]
  passwordResetTokens PasswordResetToken[]
  organizations     OrganizationMember[]
  invitationsSent   Invitation[] @relation("InvitedBy")
  socialAccounts    SocialAccount[]
  drafts            Draft[]
  contentTemplates  ContentTemplate[]
  conversations     Conversation[]

  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  lastLoginAt       DateTime?

  @@index([email])
  @@index([status])
  @@map("users")
}

model Session {
  id            String   @id @default(cuid())
  sessionToken  String   @unique
  refreshToken  String   @unique
  userId        String
  expires       DateTime

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([sessionToken])
  @@index([refreshToken])
  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  id         String   @id @default(cuid())
  identifier String   // email address
  token      String   @unique
  expires    DateTime
  userId     String

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())

  @@unique([identifier, token])
  @@index([token])
  @@map("verification_tokens")
}

model PasswordResetToken {
  id         String   @id @default(cuid())
  token      String   @unique
  expires    DateTime
  userId     String
  used       Boolean  @default(false)

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

// ========================================
// ORGANIZATION & TEAM MODELS
// ========================================

model Organization {
  id              String    @id @default(cuid())
  name            String
  slug            String    @unique
  description     String?
  logo            String?
  website         String?

  // Relations
  members         OrganizationMember[]
  invitations     Invitation[]
  socialAccounts  SocialAccount[]
  drafts          Draft[]
  contentTemplates ContentTemplate[]
  conversations   Conversation[]

  // Settings
  settings        Json      @default("{}")

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([slug])
  @@map("organizations")
}

model OrganizationMember {
  id              String    @id @default(cuid())
  userId          String
  organizationId  String
  role            MemberRole @default(MEMBER)

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  joinedAt        DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@map("organization_members")
}

model Invitation {
  id              String    @id @default(cuid())
  email           String
  token           String    @unique
  role            MemberRole @default(MEMBER)
  organizationId  String
  invitedById     String

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedBy       User      @relation("InvitedBy", fields: [invitedById], references: [id])

  expiresAt       DateTime
  acceptedAt      DateTime?

  createdAt       DateTime  @default(now())

  @@index([token])
  @@index([email])
  @@index([organizationId])
  @@map("invitations")
}

// ========================================
// SOCIAL MEDIA MODELS
// ========================================

model SocialAccount {
  id              String    @id @default(cuid())
  userId          String
  organizationId  String?

  // Platform details
  platform        SocialPlatform
  platformId      String    // ID on the social platform
  username        String?
  displayName     String?
  profileUrl      String?
  profileImage    String?

  // OAuth tokens (encrypted in production)
  accessToken     String    @db.Text
  refreshToken    String?   @db.Text
  tokenExpiry     DateTime?

  // Platform-specific data
  scope           String[]  // Permissions granted
  platformData    Json?     // Store platform-specific metadata

  // Statistics
  followersCount  Int       @default(0)
  followingCount  Int       @default(0)
  postsCount      Int       @default(0)

  // Status
  status          AccountStatus @default(ACTIVE)
  lastSyncAt      DateTime?

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  posts           Post[]
  scheduledPosts  ScheduledPost[]
  analytics       Analytics[]
  optimalPostingTimes OptimalPostingTime[]

  // Timestamps
  connectedAt     DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([userId, platform, platformId])
  @@index([userId])
  @@index([organizationId])
  @@index([platform])
  @@index([status])
  @@map("social_accounts")
}

model Post {
  id              String    @id @default(cuid())
  userId          String
  organizationId  String?

  // Content
  content         String    @db.Text
  media           Media[]
  hashtags        String[]
  mentions        String[]

  // Publishing
  socialAccountId String
  platformPostId  String?   // ID of the post on the platform
  publishedAt     DateTime?
  status          PostStatus @default(DRAFT)

  // Engagement metrics
  likes           Int       @default(0)
  comments        Int       @default(0)
  shares          Int       @default(0)
  views           Int       @default(0)

  // Relations
  socialAccount   SocialAccount @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)
  scheduledPost   ScheduledPost?

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([organizationId])
  @@index([socialAccountId])
  @@index([status])
  @@map("posts")
}

model ScheduledPost {
  id              String    @id @default(cuid())
  postId          String    @unique
  socialAccountId String
  userId          String
  organizationId  String?

  scheduledFor    DateTime
  timezone        String    @default("UTC")

  // Queue management
  queuePosition   Int?      // Position in the posting queue
  queueId         String?   // Reference to PostingQueue

  // Recurring posts
  isRecurring     Boolean   @default(false)
  recurringPattern RecurringPattern?
  recurringEndDate DateTime?

  // Status tracking
  status          ScheduleStatus @default(PENDING)
  publishAttempts Int       @default(0)
  lastError       String?

  // Optimal time suggestion
  isOptimalTime   Boolean   @default(false)
  suggestedBy     String?   // 'AI', 'USER', 'SYSTEM'

  // Relations
  post            Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  socialAccount   SocialAccount @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)
  queue           PostingQueue? @relation(fields: [queueId], references: [id])
  recurringGroup  RecurringPostGroup?

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([scheduledFor])
  @@index([socialAccountId])
  @@index([status])
  @@index([queueId])
  @@map("scheduled_posts")
}

// New model for posting queues
model PostingQueue {
  id              String    @id @default(cuid())
  userId          String
  organizationId  String?
  name            String
  description     String?

  // Queue settings
  isActive        Boolean   @default(true)
  timezone        String    @default("UTC")

  // Time slots for this queue
  timeSlots       QueueTimeSlot[]

  // Posts in this queue
  scheduledPosts  ScheduledPost[]

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([organizationId])
  @@map("posting_queues")
}

// Time slots for queue-based scheduling
model QueueTimeSlot {
  id              String    @id @default(cuid())
  queueId         String

  dayOfWeek       Int       // 0-6 (Sunday-Saturday)
  time            String    // HH:MM format
  isActive        Boolean   @default(true)

  // Relations
  queue           PostingQueue @relation(fields: [queueId], references: [id], onDelete: Cascade)

  createdAt       DateTime  @default(now())

  @@unique([queueId, dayOfWeek, time])
  @@map("queue_time_slots")
}

// Recurring post groups
model RecurringPostGroup {
  id              String    @id @default(cuid())
  userId          String
  organizationId  String?

  name            String
  pattern         RecurringPattern
  frequency       Int       @default(1) // Every N days/weeks/months
  daysOfWeek      Int[]     // For weekly: 0-6
  dayOfMonth      Int?      // For monthly: 1-31

  startDate       DateTime
  endDate         DateTime?
  nextRunDate     DateTime?

  isActive        Boolean   @default(true)

  // Relations
  scheduledPost   ScheduledPost @relation(fields: [scheduledPostId], references: [id])
  scheduledPostId String        @unique

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([nextRunDate])
  @@map("recurring_post_groups")
}

// Campaign for bulk scheduling
model Campaign {
  id              String    @id @default(cuid())
  userId          String
  organizationId  String?

  name            String
  description     String?
  startDate       DateTime
  endDate         DateTime

  status          CampaignStatus @default(DRAFT)

  // Campaign posts
  posts           CampaignPost[]

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([status])
  @@map("campaigns")
}

model CampaignPost {
  id              String    @id @default(cuid())
  campaignId      String
  postId          String

  orderIndex      Int       // Order within the campaign
  dayOffset       Int       // Days from campaign start
  timeOfDay       String    // HH:MM format

  // Relations
  campaign        Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdAt       DateTime  @default(now())

  @@unique([campaignId, postId])
  @@map("campaign_posts")
}

// Optimal posting times
model OptimalPostingTime {
  id              String    @id @default(cuid())
  socialAccountId String
  platform        Platform

  dayOfWeek       Int       // 0-6
  hour            Int       // 0-23
  score           Float     // Engagement score for this time

  // Metrics used for calculation
  avgEngagement   Float
  avgReach        Float
  sampleSize      Int

  // Relations
  socialAccount   SocialAccount @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)

  lastCalculated  DateTime
  createdAt       DateTime  @default(now())

  @@unique([socialAccountId, dayOfWeek, hour])
  @@index([socialAccountId, score])
  @@map("optimal_posting_times")
}

model Media {
  id              String    @id @default(cuid())
  postId          String?

  // File details
  url             String
  thumbnailUrl    String?
  type            MediaType
  mimeType        String
  size            Int       // in bytes
  width           Int?
  height          Int?
  duration        Int?      // for videos, in seconds

  // Metadata
  title           String?
  description     String?
  altText         String?

  // Relations
  post            Post?     @relation(fields: [postId], references: [id], onDelete: Cascade)

  // Timestamps
  uploadedAt      DateTime  @default(now())

  @@index([postId])
  @@map("media")
}

model Analytics {
  id              String    @id @default(cuid())
  socialAccountId String

  // Metrics
  date            DateTime
  impressions     Int       @default(0)
  reach           Int       @default(0)
  engagement      Int       @default(0)
  clicks          Int       @default(0)

  // Growth metrics
  followersGained Int       @default(0)
  followersLost   Int       @default(0)

  // Platform-specific metrics
  platformMetrics Json?

  // Relations
  socialAccount   SocialAccount @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt       DateTime  @default(now())

  @@unique([socialAccountId, date])
  @@index([socialAccountId])
  @@index([date])
  @@map("analytics")
}

// ========================================
// ENUMS
// ========================================

enum UserRole {
  SUPER_ADMIN
  ADMIN
  USER
}

enum UserStatus {
  PENDING
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum MemberRole {
  OWNER
  ADMIN
  EDITOR
  MEMBER
  VIEWER
}

enum SocialPlatform {
  FACEBOOK
  INSTAGRAM
  TWITTER
  LINKEDIN
  TIKTOK
  YOUTUBE
  PINTEREST
  SNAPCHAT
  REDDIT
  THREADS
}

enum AccountStatus {
  ACTIVE
  INACTIVE
  EXPIRED
  REVOKED
  ERROR
}

enum PostStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  FAILED
  DELETED
}

enum MediaType {
  IMAGE
  VIDEO
  GIF
  AUDIO
  DOCUMENT
}

enum ScheduleStatus {
  PENDING
  QUEUED
  PUBLISHING
  PUBLISHED
  FAILED
  CANCELLED
}

enum RecurringPattern {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  CUSTOM
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum Platform {
  FACEBOOK
  INSTAGRAM
  TWITTER
  LINKEDIN
  TIKTOK
}

// ========================================
// CONTENT MANAGEMENT MODELS
// ========================================

model Draft {
  id              String    @id @default(cuid())
  userId          String
  organizationId  String?

  // Content
  title           String?
  content         String    @db.Text
  platforms       SocialPlatform[]
  mediaUrls       String[]
  hashtags        String[]

  // AI Generation
  aiGenerated     Boolean   @default(false)
  aiPrompt        String?   @db.Text
  aiModel         String?

  // Scheduling
  scheduledFor    DateTime?

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([organizationId])
  @@map("drafts")
}

model ContentTemplate {
  id              String    @id @default(cuid())
  userId          String?
  organizationId  String?

  // Template info
  name            String
  description     String?
  category        String?

  // Content
  template        String    @db.Text
  variables       String[]  // Variable placeholders in template
  platforms       SocialPlatform[]

  // Usage
  isPublic        Boolean   @default(false)
  usageCount      Int       @default(0)

  // Relations
  user            User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([organizationId])
  @@index([isPublic])
  @@index([category])
  @@map("content_templates")
}

// ========================================
// AI CHAT & CONVERSATION MODELS
// ========================================

model Conversation {
  id              String    @id @default(cuid())
  userId          String
  organizationId  String?

  // Conversation metadata
  title           String?   // Optional conversation title
  topic           String?   // Main topic/context
  isActive        Boolean   @default(true)

  // Context awareness
  currentPage     String?   // Page where conversation started
  featureContext  String?   // Feature being used
  userIntent      String?   // Inferred user intent

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  messages        Message[]

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastMessageAt   DateTime  @default(now())

  @@index([userId])
  @@index([organizationId])
  @@index([isActive])
  @@index([lastMessageAt])
  @@map("ai_conversations")
}

model Message {
  id              String    @id @default(cuid())
  conversationId  String

  // Message content
  content         String    @db.Text
  role            MessageRole

  // AI-specific metadata
  model           String?   // AI model used for response
  tokens          Int?      // Token count
  responseTime    Int?      // Response time in milliseconds
  confidenceScore Float?    // AI confidence (0-1)

  // User feedback
  isHelpful       Boolean?  // User feedback
  feedback        String?   // Additional feedback text

  // Context and intent
  intent          String?   // Detected user intent
  suggestedActions String[] // AI-suggested follow-up actions

  // Relations
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt       DateTime  @default(now())

  @@index([conversationId])
  @@index([role])
  @@index([createdAt])
  @@map("ai_messages")
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

// ========================================
// AI SUPPORT & KNOWLEDGEBASE MODELS
// ========================================

model Document {
  id              String    @id @default(cuid())

  // Document metadata
  path            String    // File path relative to docs root
  title           String    // Document title
  section         String?   // Section within document (e.g., heading)

  // Content
  content         String    @db.Text // Chunk content (800 tokens ~= 3200 chars)
  rawContent      String?   @db.Text // Original markdown before processing

  // Vector embedding
  embedding       Unsupported("vector(1536)")? // OpenAI text-embedding-3-small

  // Chunking metadata
  chunkIndex      Int       // Order within document
  chunkCount      Int       // Total chunks in document
  tokenCount      Int       @default(0) // Approximate token count

  // Document classification
  category        String?   // e.g., "troubleshooting", "api", "faq"
  tags            String[]  // Searchable tags

  // Content quality indicators
  contentHash     String    // MD5 hash for change detection
  lastModified    DateTime  // File modification time

  // Search and retrieval metadata
  searchKeywords  String[]  // Extracted keywords for search
  citations       String[]  // Referenced files/sections

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([path])
  @@index([category])
  @@index([lastModified])
  @@index([section])
  @@map("ai_documents")
}

model KnowledgebaseStats {
  id              String    @id @default(cuid())

  // Statistics
  totalDocuments  Int       @default(0)
  totalChunks     Int       @default(0)
  totalTokens     BigInt    @default(0)
  avgChunkSize    Float     @default(0)

  // Last ingestion info
  lastIngestionAt DateTime?
  lastIngestionDuration Int? // milliseconds
  documentsProcessed Int   @default(0)
  errorsCount     Int       @default(0)

  // Version tracking
  schemaVersion   String    @default("1.0")

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("knowledgebase_stats")
}

model SupportQuery {
  id              String    @id @default(cuid())

  // Query details
  query           String    @db.Text
  userId          String?   // Optional user context
  sessionId       String?   // Session tracking

  // Query processing
  queryEmbedding  Unsupported("vector(1536)")? // Query vector
  retrievedChunks Json[]    // Retrieved document chunks

  // Response details
  response        String?   @db.Text // AI generated response
  responseTime    Int?      // Response time in milliseconds
  confidenceScore Float?    // AI confidence (0-1)

  // Quality metrics
  wasHelpful      Boolean?  // User feedback
  escalatedToHuman Boolean  @default(false)
  ticketId        String?   // If escalated to support ticket

  // Context
  userPlan        String?   // User's subscription plan
  userRole        String?   // User's role in organization
  featureContext  String?   // What feature they were using

  // Timestamps
  createdAt       DateTime  @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([wasHelpful])
  @@index([escalatedToHuman])
  @@map("support_queries")
}
